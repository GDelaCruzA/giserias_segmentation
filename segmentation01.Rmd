---
title: "Image segmentation"
output: html_notebook
---

Ensayo de Segmentación de imágenes RGB, basado en el ejercicio publicado por [Ivan Lizarazo](https://rpubs.com/ials2un/segment_rgb) en formato de Notebook.

```{r}
library ("rasterVis") |> suppressPackageStartupMessages()
library ('OpenImageR') |> suppressPackageStartupMessages()
library ('RImagePalette') |> suppressPackageStartupMessages()
library("raster") |> suppressPackageStartupMessages()
source(file = "indices_vegetacion_RGB.R")
```

## Índices de vegetación

Se lee la imagen a analizar:

```{r, warning = FALSE}
(crops <- stack("~/giserias/conchalito-vuelo2/conchal_10.tif"))
```

Vemos la imagen cargada:

```{r}
plotRGB(crops, 1, 2, 3)
```

Se definen las funciones auxiliares:

```{r}
# from Matthias Forkel the palette for vegetation indices:

rampa <- function(n) {
    .fun <- colorRampPalette(c("chocolate4", "orange", "yellow", "grey", "green", "green3", "darkgreen"))
    col <- .fun(n)
    return(col)
}

# rescala entre 0 y 1 la matriz de los IV para OpenImageR
normaIV <- function(x) {
  min <- min(x)
  max <- max(x)
  return(1* (x - min) / (max - min))
}
```

Calculamos el índice de exceso de verde

```{r, warning = FALSE}
(crops_egvi <- EGVI(crops))

```

y visualizamos

```{r}
intervalos <- seq(-0.35, 1, by=0.1)
colores <- rampa(length(intervalos)-1)
##plot(ndvitrend, 2, col=colores, breaks=classbreaks)
plot(crops_egvi, 2, col = colores, breaks=intervalos, main = "ExG Vegetation Index")
# guardamos en formato 
```

## Segmentación de imágenes

Se usa el paquete {OpenImageR} que permite leer la imagen a evaluar en el formato adecuado al análisis con este paquete.

```{r}
# con OpenImageR
conchal <- readImage("~/giserias/conchalito-vuelo2/conchal_10.tif")
#conchal <- readImage("~/giserias/conchalito-vuelo2/RPubs_crops.jpg")
```

Ahora usamos el algoritmo SLIC para una primera aproximación.

```{r, warning = FALSE}
conchal.slic = superpixels(input_image = conchal[, , 1:3], 
                           method = "slic", 
                           superpixel = 200, 
                           compactness = 20, 
                           return_slic_data = TRUE, 
                           return_labels = TRUE, 
                           write_slic = "",
                           verbose = TRUE)
```

El otro algoritmo

```{r, warning = FALSE}
conchal.slico = superpixels(input_image = conchal[, , 1:3], 
                            method = "slico", 
                            superpixel = 500,
   return_slic_data = TRUE,
   return_labels = TRUE, write_slic = "",
   verbose = TRUE)

```

Desplegamos el resultado:

```{r}
imageShow(conchal.slic$slic_data)
```

Nota: posiblemente por el tamaño, no se despliega por ahora la imagen, pero si se repite la instrucción en la consola, se despliega en **Plots**

```{r}
imageShow(conchal.slico$slic_data)
```

Nota: Idem...

El procesamiento adicional se haría con el módulo {SuperPixelImageSegmentation}, que se tratará más adelante. Por ahora seguimos con la parte 3. Data Analysis del tutorial.

Primero ajustamos la imagen 'conchal' porque se lee con 4 capas

```{r}
conchal <- conchal[, , 1:3] # ajuste para el conchalito
imageShow(conchal) # hasta aquí, OK
#plotRGB(conchal)
#plot(conchal)
#plot(conchal, 2, main = "ExG Vegetation Index")

```

Nota: idem

Tomamos la imagen con el resultados del índice de vegetación y lo transformamos a matriz para poder tratarla con {OpenImageR}

```{r}
# OJO: las funciones de los indices no contemplan matrices(x, y, 1:3)
str(conchal)
conchal_egvi <- EGVI(conchal)
str(conchal_egvi)

```

```{r}
crops_egvi_mat <- matrix(crops_egvi@data@values,
            nrow = crops_egvi@nrows,
            ncol = crops_egvi@ncols, byrow = TRUE)

# o mediante
```

Como en los índices hay valores negativos, para poder desplegarlos, los tenemos que normalizar a (0, 1) o (0, 255)...

```{r}
crops_egvi_mat_norm <- normaIV(crops_egvi_mat)
# crops_egvi_mat_norm <- raster::as.matrix(crops_egvi)
str(crops_egvi_mat_norm)
min(crops_egvi_mat_norm)
max(crops_egvi_mat_norm)
```

Vemos como queda:

```{r}
imageShow(crops_egvi_mat_norm)
```

Como no fununcia, guardamos como imagen el resultado de los índices y luego la leemos directamente con la función readImage() de {OpenImageR}

```{r}
conchal_egvi_tif <- readImage("conchal_egvi.tif")
```

la vemos

```{r}
imageShow(conchal_egvi_tif)
```
