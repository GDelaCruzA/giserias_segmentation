---
title: "Image segmentation"
output: html_notebook
---

Ensayo de Segmentación de imágenes RGB, basado en el ejercicio publicado por [Ivan Lizarazo](https://rpubs.com/ials2un/segment_rgb) en formato de Notebook.

```{r}
library ("rasterVis") |> suppressPackageStartupMessages()
library ('OpenImageR') |> suppressPackageStartupMessages()
library ('RImagePalette') |> suppressPackageStartupMessages()
library("raster") |> suppressPackageStartupMessages()
```

## Índices de vegetación

Se lee la imagen a analizar:

```{r}
(crops <- stack("~/giserias/conchalito-vuelo2/conchal_10.tif"))
```

Vemos la imagen cargada:

```{r}
plotRGB(crops, 1, 2, 3)
```

Se definen las funciones auxiliares:

```{r}
# Excess green vegetation index
ExG <- function(img, i, j, k) {
  bi <- img[[i]]
  bj <- img[[j]]
  bk <- img[[k]]
  vi <- (2*bj-bi-bk) / (bj + bk +bi)
  return(vi)
}

# Normalized green red difference index
NGRDI <- function(img, i, j, k) {
  bi <- img[[i]]
  bj <- img[[j]]
  bk <- img[[k]]
  vi <- (bj-bi) / (bj + bi)
  return(vi)
}

# Thanks to Matthias Forkel we can use a nice palette for vegetation indices:
colores <- function(n) {
    .fun <- colorRampPalette(c("chocolate4", "orange", "yellow", "grey", "green", "green3", "darkgreen"))
    col <- .fun(n)
    return(col)
}


```

Calculamos y vemos el índice de exceso de verde

```{r}
(egvi <- ExG(crops, 1, 2,3))

```

y visualizamos

```{r}
cortes <- seq(-0.35, 1, by=0.1)
cols <- colores(length(cortes)-1)
##plot(ndvitrend, 2, col=cols, breaks=classbreaks)
plot(egvir, 2, col = cols, breaks=cortes, main = "ExG Vegetation Index")
```

## Segmentación de imágenes

Se usa el paquete {OpenImageR} que permite leer la imagen a evaluar en el formato adecuado al análisis con este paquete.

```{r}
conchal <- readImage("~/giserias/conchalito-vuelo2/conchal_10.tif")
```

Ahora usamos el algoritmo SLIC para una primera aproximación.

```{r}
conchal.slic = superpixels(input_image = conchal[, , 1:3], method = "slic", superpixel = 200,
   compactness = 20, return_slic_data = TRUE,
   return_labels = TRUE, write_slic = "",
   verbose = FALSE)
```

El otro algoritmo

```{r}
conchal.slico = superpixels(input_image = conchal[, , 1:3], method = "slico", superpixel = 150,
   return_slic_data = TRUE,
   return_labels = TRUE, write_slic = "",
   verbose = FALSE)

```

Desplegamos el resultado:

```{r}
imageShow(conchal.slic$slic_data)
```

```{r}
imageShow(conchal.slico$slic_data)
```
